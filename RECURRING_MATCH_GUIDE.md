# 정기모임 자동 생성 시스템 가이드

## 🎯 개요

정기적으로 반복되는 배드민턴 모임을 자동으로 생성하는 시스템입니다. 관리자가 템플릿을 설정하면, 시스템이 자동으로 해당 요일에 경기 일정을 생성합니다.

## 🏗️ 시스템 구성

### 1. 데이터베이스 구조

- **`recurring_match_templates`**: 정기모임 템플릿 저장
- **`match_schedules`**: 생성된 경기 일정 저장
- **자동 생성 함수**: `generate_recurring_matches()`, `daily_match_generation()`

### 2. 웹 인터페이스

- **정기모임 관리 페이지**: `/recurring-matches` (관리자 전용)
- **템플릿 생성/수정/삭제** 기능
- **수동 실행** 버튼

### 3. 자동 실행 시스템

- **API 엔드포인트**: `/api/cron/recurring-matches`
- **GitHub Actions**: 매일 오전 6시 자동 실행
- **수동 실행**: 관리자 페이지에서 즉시 실행 가능

## 🚀 설정 방법

### 1. 데이터베이스 설정

```sql
-- RECURRING_MATCH_SYSTEM.sql 파일을 Supabase에서 실행
```

### 2. 환경 변수 설정

```env
# .env.local 파일에 추가
CRON_SECRET_TOKEN=your-super-secret-token-here
```

### 3. GitHub Secrets 설정 (자동 실행용)

GitHub 리포지토리의 Settings > Secrets에서 다음을 설정:

- `CRON_SECRET_TOKEN`: API 호출을 위한 보안 토큰
- `NEXT_PUBLIC_SITE_URL`: 배포된 사이트 URL

## 📋 사용 방법

### 1. 정기모임 템플릿 생성

1. `/recurring-matches` 페이지 접속 (관리자만)
2. "새 정기모임 템플릿 추가" 버튼 클릭
3. 다음 정보 입력:
   - **모임 이름**: 예) "주말 정기모임"
   - **요일**: 매주 반복할 요일 선택
   - **시간**: 시작/종료 시간
   - **장소**: 경기 장소
   - **최대 참가자**: 참가 가능한 최대 인원
   - **미리 생성할 일수**: 몇 일 전에 미리 일정을 만들지 설정
   - **설명**: 모임에 대한 추가 설명

### 2. 자동 생성 확인

- **매일 오전 6시**에 자동으로 실행
- **미리 생성할 일수**만큼 미래의 일정을 생성
- 이미 생성된 일정은 중복 생성하지 않음

### 3. 수동 실행

- 정기모임 관리 페이지에서 "지금 정기모임 생성 실행" 버튼 클릭
- 즉시 조건에 맞는 정기모임들이 생성됨

## ⚙️ 고급 설정

### 1. 실행 시간 변경

GitHub Actions 파일(`.github/workflows/recurring-matches.yml`)에서 cron 설정 수정:

```yaml
schedule:
  - cron: '0 21 * * *'  # UTC 21:00 = 한국시간 06:00
```

### 2. 로직 커스터마이징

`RECURRING_MATCH_SYSTEM.sql`의 `generate_recurring_matches()` 함수를 수정하여 생성 로직 변경 가능

### 3. 알림 시스템 연동

향후 Slack, 이메일 등의 알림 시스템과 연동하여 일정 생성 시 자동 알림 가능

## 📊 모니터링

### 1. 실행 로그 확인

- GitHub Actions의 "Actions" 탭에서 실행 결과 확인
- 정기모임 관리 페이지에서 마지막 실행 결과 확인

### 2. 생성된 일정 확인

- `/match-schedule` 페이지에서 생성된 일정 확인
- 정기모임으로 생성된 일정은 설명에 "정기모임"이 포함됨

## 🔧 트러블슈팅

### 문제: 자동 생성이 안 됨

1. GitHub Secrets 확인
2. 데이터베이스 함수 정상 작동 확인
3. 템플릿이 활성화되어 있는지 확인
4. API 엔드포인트 응답 확인

### 문제: 중복 일정 생성

- 정상 동작: 시스템은 이미 존재하는 일정은 중복 생성하지 않음
- 같은 날짜, 시간, 장소의 일정이 이미 있으면 스킵

### 문제: 권한 오류

- 관리자 권한 확인
- RLS 정책 확인
- 인증 상태 확인

## 💡 팁

1. **테스트 실행**: 새 템플릿 생성 후 수동 실행으로 테스트
2. **미리 생성 일수**: 보통 7-14일이 적당
3. **템플릿 비활성화**: 일시적으로 중단하고 싶을 때 "비활성화" 사용
4. **다중 템플릿**: 여러 요일, 시간대의 정기모임 동시 운영 가능

## 🔄 업데이트 예정 기능

- [ ] 이메일/SMS 알림 시스템
- [ ] 휴일 자동 건너뛰기
- [ ] 계절별 템플릿 활성화/비활성화
- [ ] 참가자 수에 따른 자동 장소 변경
- [ ] 웹훅 지원 (Slack, Discord 등)

## 🧭 매치 생성 공정성 지침

자동 경기 생성 로직의 공정성 강화를 위해 아래 지침을 따릅니다. 이 규칙은 '레벨별', '랜덤', '혼합복식' 세 가지 생성 방식 모두에 동일하게 적용됩니다.

1. 모든 선수 포함
  - 현재 `present` 상태인 모든 선수를 경기 생성 풀에 반드시 포함합니다. 어느 라운드에서도 출석한 선수가 배제되지 않도록 우선순위를 둡니다.

2. 총 경기 수 계산
  - 기본 공식: 총 필요 경기 수 = ceil((총 참가 선수 수 * 1인당 목표 경기 수) / 4)
  - 이 값(`targetMatches`)을 기준으로 기본 매칭을 생성하며, 커버리지(모든 선수가 목표경기수 충족)를 위해 별도 보정 단계를 둡니다.

3. 균등 분배 로직
  - 선수별로 현재 생성된 경기 수를 추적합니다.
  - 다음 라운드 구성 시에는 경기 수가 가장 적은 선수들을 우선적으로 배정합니다(오름차순 정렬 후 우선배치).
  - 참가 인원이 4의 배수가 아닐 경우 일부 선수는 한 경기 더 뛰게 될 수 있으나, 추가 경기는 가능한 한 최소화합니다.

4. 팀 점수 균형(핵심 규칙)
  - 매치의 두 팀 간 팀 점수 차이는 원칙적으로 0(동점) 또는 1 이내로 제한합니다.
  - 즉, 가능한 경우 팀 점수 차 ≤ 1인 상대팀 조합을 우선 선택합니다.
  - 만약 전혀 불가능한 경우에는 '최소 점수 차' 조합을 선택하여 균형을 최대한 유지합니다.

5. 커버리지 단계
  - 기본 매칭(위의 targetMatches 기준)으로 모든 선수가 목표를 달성하지 못한 경우, 다음 방식으로 보충합니다:
    - 레벨/혼합 모드: 부족 선수들을 우선으로 모아 가능한 한 팀 점수 차 ≤ 1인 조합을 만들어 추가 매치를 생성합니다(필요시 제한된 반복으로만 생성).
    - 랜덤 모드: 경기 수를 늘리지 않기 위해 기존 매치의 참가자를 스왑하는 방식으로 부족 선수를 집어넣습니다. 이때 스왑 결과가 팀 점수 차 ≤ 1을 만족하는지 확인합니다.

6. 적용 및 튜닝 포인트
  - 구현 시 상수로 `MAX_TEAM_SCORE_DIFF = 1`을 두어 추후 정책 변경(예: 0 또는 2 허용) 시 쉽게 조정할 수 있게 합니다.
  - 드물게 균형 제약 때문에 목표를 채우지 못하는 경우, 로그를 남기고 최소 차이 조합으로 보완합니다.

이 지침은 자동 생성 함수와 프론트엔드의 매치 생성 컨트롤(예: `perPlayerMinGames`)에 반영되어야 합니다.
